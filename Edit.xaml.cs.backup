using System.Text.Json;
using System.Diagnostics;
using System.Text.RegularExpressions;
using System.IO.Compression;
using SkiaSharp;
using SkiaSharp.Views.Maui;
using System.Web;
using System.Reflection;

namespace AnkiPlus_MAUI
{
    public partial class Edit : ContentPage
    {
        private string tempExtractPath;
        private string ankplsFilePath;
        private List<CardInfo> cards = new List<CardInfo>();
        private List<CardInfo> filteredCards = new List<CardInfo>(); // æ¤œç´¢çµæœç”¨
        private string editCardId = null;    // ç·¨é›E¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰ID
        private bool isDirty = false;        // å¤‰æ›´ãŒã‚ã‚‹ã‹ã©ãE‹ã®ãƒ•ãƒ©ã‚°
        private System.Timers.Timer autoSaveTimer;  // è‡ªå‹•ä¿å­˜ç”¨ã‚¿ã‚¤ãƒãE
        private List<SKRect> selectionRects = new List<SKRect>();  // ç”»åƒç©´åŸ‹ã‚ç”¨ã®é¸æŠç¯E›²
        private SKBitmap imageBitmap;         // ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ“ãƒƒãƒˆãEãƒEE
        private SKPoint startPoint, endPoint;
        private bool isDragging = false;
        private const float HANDLE_SIZE = 15;



        public class CardInfo
        {
            public string Id { get; set; }
            public string FrontText { get; set; }
            public string ImageInfo { get; set; }
            public bool HasImage { get; set; }
            public string LastModified { get; set; }
        }

        public Edit(string notePath, string tempPath)
        {
            try
            {
                Debug.WriteLine("Edit.xaml.cs ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿é–‹å§E);
                InitializeComponent();

                tempExtractPath = tempPath;
                ankplsFilePath = notePath;

                // ãƒãEãƒˆåã‚’è¨­å®E                NoteTitleLabel.Text = Path.GetFileNameWithoutExtension(ankplsFilePath);

                // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
                LoadCards();

                // è‡ªå‹•ä¿å­˜ã‚¿ã‚¤ãƒãEã®è¨­å®E                autoSaveTimer = new System.Timers.Timer(5000); // 5ç§’ã”ã¨ã«è‡ªå‹•ä¿å­E                autoSaveTimer.Elapsed += AutoSaveTimer_Elapsed;
                autoSaveTimer.AutoReset = false; // ä¸€åº¦ã ã‘å®Ÿè¡E
                // ãƒE‚­ã‚¹ãƒˆå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãEè¨­å®E                FrontTextEditor.TextChanged += OnTextChanged;
                BackTextEditor.TextChanged += OnTextChanged;
                ChoiceQuestion.TextChanged += OnChoiceQuestionTextChanged;
                ChoiceQuestionExplanation.TextChanged += OnChoiceExplanationTextChanged;

                // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ãEåˆæœŸè¨­å®E                CardTypePicker.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Edit.xaml.cs ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                Debug.WriteLine($"ã‚¹ã‚¿ãƒE‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: {ex.StackTrace}");
                throw;
            }
        }

        private void LoadCards()
        {
            try
            {
                Debug.WriteLine("LoadCardsé–‹å§E);
                var cardsFilePath = Path.Combine(tempExtractPath, "cards.txt");
                var cardsDirPath = Path.Combine(tempExtractPath, "cards");

                if (File.Exists(cardsFilePath))
                {
                    var lines = File.ReadAllLines(cardsFilePath);
                    if (lines.Length > 1) // 1è¡Œç›®ã¯ã‚«ãƒ¼ãƒ‰æ•°
                    {
                        cards.Clear();
                        for (int i = 1; i < lines.Length; i++)
                        {
                            var parts = lines[i].Split(',');
                            if (parts.Length >= 2)
                            {
                                var cardId = parts[0];
                                var lastModified = DateTime.ParseExact(parts[1].Trim(), "yyyy-MM-dd HH:mm:ss", null);
                                var jsonPath = Path.Combine(cardsDirPath, $"{cardId}.json");

                                if (File.Exists(jsonPath))
                                {
                                    var jsonContent = File.ReadAllText(jsonPath);
                                    var cardData = JsonSerializer.Deserialize<CardData>(jsonContent);

                                    var cardInfo = new CardInfo
                                    {
                                        Id = cardId,
                                        FrontText = cardData.type == "é¸æŠè‚¢" ? cardData.question : cardData.front,
                                        LastModified = lastModified.ToString("yyyy-MM-dd HH:mm:ss")
                                    };

                                    // ç”»åƒæƒ…å ±ã‚’å–å¾E                                    var imageMatches = System.Text.RegularExpressions.Regex.Matches(cardInfo.FrontText, @"<<img_\d{8}_\d{6}\.jpg>>");
                                    if (imageMatches.Count > 0)
                                    {
                                        cardInfo.HasImage = true;
                                        cardInfo.ImageInfo = $"ç”»åƒE {string.Join(", ", imageMatches.Select(m => m.Value))}";
                                    }

                                    cards.Add(cardInfo);
                                }
                            }
                        }

                        // ã‚«ãƒ¼ãƒ‰ã‚’æœ€çµ‚æ›´æ–°æ—¥æ™‚ãEé™é E§ã‚½ãƒ¼ãƒE                        cards = cards.OrderByDescending(c => DateTime.Parse(c.LastModified)).ToList();
                        filteredCards = new List<CardInfo>(cards);
                        CardsCollectionView.ItemsSource = filteredCards;
                        TotalCardsLabel.Text = $"ã‚«ãƒ¼ãƒ‰æšæ•°: {cards.Count}";
                        UpdateSearchResult();
                    }
                }
                Debug.WriteLine("LoadCardså®ŒäºE);
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"LoadCardsã§ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                Debug.WriteLine($"ã‚¹ã‚¿ãƒE‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: {ex.StackTrace}");
                throw;
            }
        }

        private void OnTextChanged(object sender, TextChangedEventArgs e)
        {
            isDirty = true;
            // ã‚¿ã‚¤ãƒãEã‚’ãƒªã‚»ãƒEƒˆ
            autoSaveTimer.Stop();
            autoSaveTimer.Start();
        }

        private void FrontOnTextChanged(object sender, TextChangedEventArgs e)
        {
            isDirty = true;
            autoSaveTimer.Stop();
            autoSaveTimer.Start();

            // JavaScriptæ‰‹æ³•ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE            UpdateFrontPreviewWithDebounce(e.NewTextValue ?? "");
        }

        private void BackOnTextChanged(object sender, TextChangedEventArgs e)
        {
            isDirty = true;
            autoSaveTimer.Stop();
            autoSaveTimer.Start();

            // JavaScriptæ‰‹æ³•ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE            UpdateBackPreviewWithDebounce(e.NewTextValue ?? "");
        }

        /// <summary>
        /// è¡¨é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE        /// </summary>
        private System.Timers.Timer _frontPreviewTimer;
        private void UpdateFrontPreviewWithDebounce(string text)
        {
            // æ—¢å­˜ãEã‚¿ã‚¤ãƒãEã‚’åœæ­¢
            _frontPreviewTimer?.Stop();
            _frontPreviewTimer?.Dispose();
            
            // æ–°ã—ã„ã‚¿ã‚¤ãƒãEã‚’ä½œæEEE00mså¾Œã«å®Ÿè¡Œï¼E            _frontPreviewTimer = new System.Timers.Timer(300);
            _frontPreviewTimer.Elapsed += (s, e) =>
            {
                MainThread.BeginInvokeOnMainThread(() =>
                {
                    try
                    {
                        FrontPreviewLabel.RichText = text;
                        FrontPreviewLabel.ShowAnswer = false;
                        FrontPreviewLabel.ImageFolderPath = tempExtractPath;
                    }
                    catch (Exception ex)
                    {
                        Debug.WriteLine($"è¡¨é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                    }
                });
                _frontPreviewTimer?.Stop();
                _frontPreviewTimer?.Dispose();
                _frontPreviewTimer = null;
            };
            _frontPreviewTimer.AutoReset = false;
            _frontPreviewTimer.Start();
        }

        /// <summary>
        /// è£é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE        /// </summary>
        private System.Timers.Timer _backPreviewTimer;
        private void UpdateBackPreviewWithDebounce(string text)
        {
            // æ—¢å­˜ãEã‚¿ã‚¤ãƒãEã‚’åœæ­¢
            _backPreviewTimer?.Stop();
            _backPreviewTimer?.Dispose();
            
            // æ–°ã—ã„ã‚¿ã‚¤ãƒãEã‚’ä½œæEEE00mså¾Œã«å®Ÿè¡Œï¼E            _backPreviewTimer = new System.Timers.Timer(300);
            _backPreviewTimer.Elapsed += (s, e) =>
            {
                MainThread.BeginInvokeOnMainThread(() =>
                {
                    try
                    {
                        BackPreviewLabel.RichText = text;
                        BackPreviewLabel.ShowAnswer = false;
                        BackPreviewLabel.ImageFolderPath = tempExtractPath;
                    }
                    catch (Exception ex)
                    {
                        Debug.WriteLine($"è£é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                    }
                });
                _backPreviewTimer?.Stop();
                _backPreviewTimer?.Dispose();
                _backPreviewTimer = null;
            };
            _backPreviewTimer.AutoReset = false;
            _backPreviewTimer.Start();
        }













        /// <summary>
        /// ã‚³ãƒ³ãƒEƒ³ãƒEƒ¨åˆEEã¿ã®HTMLã‚’ç”ŸæˆE        /// </summary>
        private string ConvertToContentHtml(string text, bool showAnswer = false)
        {
            if (string.IsNullOrWhiteSpace(text)) return "";

            // ç”»åƒã‚¿ã‚°ã‚’æœ€åˆã«å‡¦çE            var matches = Regex.Matches(text, @"<<img_.*?\.jpg>>");
            Debug.WriteLine($"ç”»åƒã‚¿ã‚°æ•°: {matches.Count}");
            foreach (Match match in matches)
            {
                string imgFileName = match.Value.Trim('<', '>');
                string imgPath = Path.Combine(tempExtractPath, "img", imgFileName);

                if (File.Exists(imgPath))
                {
                    string base64Image = ConvertImageToBase64(imgPath);
                    if (base64Image != null)
                    {
                        text = text.Replace(match.Value, $"<img src={base64Image} style=max-height:150px; />");
                    }
                    else
                    {
                        text = text.Replace(match.Value, $"[ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {imgFileName}]");
                    }
                }
                else
                {
                    text = text.Replace(match.Value, $"[ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {imgFileName}]");
                }
            }

            // ç©´åŸ‹ã‚è¡¨ç¤ºå‡¦çE¼EavaScriptæ“ä½œç”¨ã®IDã‚’ä»˜ä¸ï¼E            var isDarkMode = Application.Current?.RequestedTheme == AppTheme.Dark;
            var redColor = isDarkMode ? "#FF6B6B" : "red";
            
            int blankCounter = 0;
            if (showAnswer)
            {
                // è§£ç­”è¡¨ç¤ºæ™‚ãE `<<blank|æ–E­E>` â†E`(æ–E­E`
                text = Regex.Replace(text, @"<<blank\|(.*?)>>", match =>
                {
                    blankCounter++;
                    var answer = match.Groups[1].Value;
                    return $"(<span id='blank_{blankCounter}' style='color:{redColor};'>{answer}</span>)";
                });
            }
            else
            {
                // å•é¡Œè¡¨ç¤ºæ™‚ãE `<<blank|æ–E­E>` â†E`( )` Eˆå¾Œã§JavaScriptã§æ“ä½œå¯èƒ½EE                text = Regex.Replace(text, @"<<blank\|(.*?)>>", match =>
                {
                    blankCounter++;
                    var answer = match.Groups[1].Value;
                    return $"(<span id='blank_{blankCounter}' data-answer='{HttpUtility.HtmlEncode(answer)}' class='blank-placeholder'> </span>)";
                });
            }

            // æ”¹è¡ŒãEæ­£è¦åŒ–ã¨æ®µè½å‡¦çE            text = text.Replace("\r\n", "\n").Replace("\r", "\n");
            
            // ç©´åŸ‹ã‚ã®spanã‚¿ã‚°ã¨imgã‚¿ã‚°ã‚’ä¸€æ™‚çš„ã«ä¿è­·
            var protectedElements = new List<string>();
            int elementIndex = 0;
            
            // spanã‚¿ã‚°ã‚’ä¿è­·
            text = Regex.Replace(text, @"<span[^>]*>.*?</span>", match =>
            {
                var placeholder = $"__ELEMENT_PLACEHOLDER_{elementIndex}__";
                protectedElements.Add(match.Value);
                elementIndex++;
                return placeholder;
            });
            
            // imgã‚¿ã‚°ã‚’ä¿è­·
            text = Regex.Replace(text, @"<img[^>]*>", match =>
            {
                var placeholder = $"__ELEMENT_PLACEHOLDER_{elementIndex}__";
                protectedElements.Add(match.Value);
                elementIndex++;
                return placeholder;
            });

            // HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒE            text = HttpUtility.HtmlEncode(text);

            // ä¿è­·ã•ã‚ŒãŸè¦ç´ ã‚’å¾©å…E            for (int i = 0; i < protectedElements.Count; i++)
            {
                text = text.Replace($"__ELEMENT_PLACEHOLDER_{i}__", protectedElements[i]);
            }

            // å¤ªå­—å¤‰æ›
            text = Regex.Replace(text, @"\*\*(.*?)\*\*", "<b>$1</b>");

            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œãEè‰²å¤‰æ›
            var blueColor = isDarkMode ? "#6BB6FF" : "blue";
            var greenColor = isDarkMode ? "#90EE90" : "green";
            var yellowColor = isDarkMode ? "#FFD700" : "yellow";
            var purpleColor = isDarkMode ? "#DA70D6" : "purple";
            var orangeColor = isDarkMode ? "#FFA500" : "orange";
            
            text = Regex.Replace(text, @"\{\{red\|(.*?)\}\}", $"<span style='color:{redColor};'>$1</span>");
            text = Regex.Replace(text, @"\{\{blue\|(.*?)\}\}", $"<span style='color:{blueColor};'>$1</span>");
            text = Regex.Replace(text, @"\{\{green\|(.*?)\}\}", $"<span style='color:{greenColor};'>$1</span>");
            text = Regex.Replace(text, @"\{\{yellow\|(.*?)\}\}", $"<span style='color:{yellowColor};'>$1</span>");
            text = Regex.Replace(text, @"\{\{purple\|(.*?)\}\}", $"<span style='color:{purpleColor};'>$1</span>");
            text = Regex.Replace(text, @"\{\{orange\|(.*?)\}\}", $"<span style='color:{orangeColor};'>$1</span>");

            // ä¸Šä»˜ããƒ»ä¸‹ä»˜ãå¤‰æ›
            text = Regex.Replace(text, @"\^\^(.*?)\^\^", "<sup>$1</sup>");
            text = Regex.Replace(text, @"~~(.*?)~~", "<sub>$1</sub>");

            // å¿E¦ãªéƒ¨åˆE ã‘ãƒ‡ã‚³ãƒ¼ãƒ‰åEçE            text = Regex.Replace(text, @"&lt;img(.*?)&gt;", "<img$1>");
            text = Regex.Replace(text, @"&lt;span(.*?)&gt;", "<span$1>");
            text = Regex.Replace(text, @"&lt;/span&gt;", "</span>");

            // æ”¹è¡ŒåEçE¼šé€£ç¶šã™ã‚‹ç©ºè¡Œã‚’æ®µè½ã¨ã—ã¦å‡¦çE            var lines = text.Split('\n');
            var processedLines = new List<string>();
            
            for (int i = 0; i < lines.Length; i++)
            {
                var line = lines[i].Trim();
                
                if (string.IsNullOrEmpty(line))
                {
                    // ç©ºè¡ŒãEå ´åˆã€æ®µè½åŒºåˆE‚Šã¨ã—ã¦å‡¦çE                    if (processedLines.Count > 0 && !processedLines.Last().EndsWith("</p>"))
                    {
                        processedLines.Add("</p><p>");
                    }
                }
                else
                {
                    // æœ€åˆãEè¡ŒãEå ´åˆãEpã‚¿ã‚°ã§é–‹å§E                    if (processedLines.Count == 0)
                    {
                        processedLines.Add("<p>" + line);
                    }
                    else if (processedLines.Last().EndsWith("</p><p>"))
                    {
                        // æ–°ã—ã„æ®µè½ã®æœ€åˆãEè¡E                        processedLines[processedLines.Count - 1] = processedLines.Last() + line;
                    }
                    else
                    {
                        // åŒã˜æ®µè½å†E§ã®æ”¹è¡E                        processedLines.Add("<br>" + line);
                    }
                }
            }
            
            // æœ€å¾Œã«pã‚¿ã‚°ã‚’é–‰ã˜ã‚‹
            if (processedLines.Count > 0 && !processedLines.Last().EndsWith("</p>"))
            {
                processedLines.Add("</p>");
            }
            
            text = string.Join("", processedLines);

            return text;
        }

        /// <summary>
        /// WebViewåˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«è¡Œã†
        /// </summary>
        private async Task EnsureWebViewInitialized(WebView webView)
        {
            try
            {
                // WebViewãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®åˆæœŸåŒ–ç¢ºèªE                if (webView?.Handler == null)
                {
                    Debug.WriteLine("WebViewãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒæœªåˆæœŸåŒE);
                    return;
                }

                // ãƒ—ãƒ©ãƒEƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ãEåˆæœŸåŒE#if WINDOWS
                var platformView = webView.Handler.PlatformView;
                if (platformView != null)
                {
                    // ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦WebView2ã®åˆæœŸåŒ–ã‚’ç¢ºèªE                    try
                    {
                        var coreWebView2Property = platformView.GetType().GetProperty("CoreWebView2");
                        if (coreWebView2Property != null)
                        {
                            var coreWebView2 = coreWebView2Property.GetValue(platformView);
                            if (coreWebView2 == null)
                            {
                                Debug.WriteLine("CoreWebView2ã‚’åEæœŸåŒ–ä¸­...");
                                var ensureMethod = platformView.GetType().GetMethod("EnsureCoreWebView2Async");
                                if (ensureMethod != null)
                                {
                                    var task = ensureMethod.Invoke(platformView, null) as Task;
                                    if (task != null)
                                    {
                                        await task;
                                        Debug.WriteLine("CoreWebView2åˆæœŸåŒ–å®ŒäºE);
                                        // åˆæœŸåŒ–å¾Œã«å°‘ã—å¾E©E                                        await Task.Delay(100);
                                    }
                                }
                            }
                        }
                    }
                    catch (Exception reflectionEx)
                    {
                        Debug.WriteLine($"ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‡¦çE‚¨ãƒ©ãƒ¼: {reflectionEx.Message}");
                    }
                }
#endif
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"WebViewåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                // åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ã¯è‡´å‘½çšE§ã¯ãªãEŸã‚ã€ç¶šè¡E            }
        }

        /// <summary>
        /// WebViewã®ã‚³ãƒ³ãƒEƒ³ãƒEƒ¨åˆEEã¿ã‚’æ›´æ–°
        /// </summary>
        private async Task UpdateWebViewContent(WebView webView, string text, bool showAnswer = false)
        {
            try
            {
                // WebViewãŒåEæœŸåŒ–ã•ã‚Œã¦ãE‚‹ã‹ãƒã‚§ãƒE‚¯
                if (webView?.Handler == null)
                {
                    Debug.WriteLine("WebViewæœªåˆæœŸåŒ–ãEãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨");
                    throw new InvalidOperationException("WebView not initialized");
                }

                // WebView2ã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«è¡Œã†
                await EnsureWebViewInitialized(webView);

                var contentHtml = ConvertToContentHtml(text, showAnswer);
                
                // JavaScriptå®Ÿè¡Œå‰ã«å°‘ã—å¾E©E                await Task.Delay(50);
                
                Debug.WriteLine($"å…EEã‚³ãƒ³ãƒEƒ³ãƒE {contentHtml}");
                
                // æ–¹æ³E: Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨Eˆã‚ˆã‚Šå®‰åEEE                try
                {
                    var contentBytes = System.Text.Encoding.UTF8.GetBytes(contentHtml);
                    var base64Content = Convert.ToBase64String(contentBytes);
                    
                    Debug.WriteLine($"Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å®Ÿè¡E updateContentBase64('{base64Content.Substring(0, Math.Min(base64Content.Length, 50))}...');");
                    await webView.EvaluateJavaScriptAsync($"updateContentBase64('{base64Content}');");
                    
                    // JavaScriptå®Ÿè¡Œå¾Œã«ç¢ºèªE                    await Task.Delay(100);
                    var consoleCheck = await webView.EvaluateJavaScriptAsync("document.getElementById('main-content').innerHTML;");
                    Debug.WriteLine($"Base64æ›´æ–°å¾ŒãEã‚³ãƒ³ãƒEƒ³ãƒE¢ºèªE {consoleCheck}");
                }
                catch (Exception base64Ex)
                {
                    Debug.WriteLine($"Base64æ–¹å¼ã‚¨ãƒ©ãƒ¼: {base64Ex.Message}");
                    
                    // æ–¹æ³E: å¾“æ¥ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—åEçE¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯EE                    try
                    {
                        var escapedContent = contentHtml
                            .Replace("\\", "\\\\")    // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒE‚·ãƒ¥ã‚’æœ€åˆã«å‡¦çE                            .Replace("'", "\\'")      // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒE                            .Replace("\"", "\\\"")    // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒE                            .Replace("\r\n", "\\n")   // æ”¹è¡Œï¼ERLFEE                            .Replace("\n", "\\n")     // æ”¹è¡Œï¼EFEE                            .Replace("\r", "\\n")     // æ”¹è¡Œï¼EREE                            .Replace("\t", "\\t");    // ã‚¿ãƒE                        
                        Debug.WriteLine($"ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–¹å¼å®Ÿè¡E updateContent('{escapedContent.Substring(0, Math.Min(escapedContent.Length, 50))}...');");
                        await webView.EvaluateJavaScriptAsync($"updateContent('{escapedContent}');");
                        
                        await Task.Delay(100);
                        var consoleCheck2 = await webView.EvaluateJavaScriptAsync("document.getElementById('main-content').innerHTML;");
                        Debug.WriteLine($"ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ›´æ–°å¾ŒãEã‚³ãƒ³ãƒEƒ³ãƒE¢ºèªE {consoleCheck2}");
                    }
                    catch (Exception escapeEx)
                    {
                        Debug.WriteLine($"ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–¹å¼ã‚¨ãƒ©ãƒ¼: {escapeEx.Message}");
                        throw;
                    }
                }
                Debug.WriteLine("WebViewã‚³ãƒ³ãƒEƒ³ãƒE›´æ–°å®ŒäºE);
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"WebViewã‚³ãƒ³ãƒEƒ³ãƒE›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                Debug.WriteLine($"ã‚¨ãƒ©ãƒ¼è©³ç´°: {ex}");
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯EšHTMLå…¨ä½“ã‚’å†èª­ã¿è¾¼ã¿
                try
                {
                    Debug.WriteLine("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œä¸­...");
                    var fullHtml = ConvertMarkdownToHtml(text ?? "");
                    webView.Source = new HtmlWebViewSource { Html = fullHtml };
                    Debug.WriteLine("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®ŒäºE);
                }
                catch (Exception fallbackEx)
                {
                    Debug.WriteLine($"ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {fallbackEx.Message}");
                }
            }
        }

        private async void AutoSaveTimer_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            if (isDirty && !string.IsNullOrEmpty(editCardId))
            {
                await SaveCurrentCard();
            }
        }

        private async Task SaveCurrentCard()
        {
            try
            {
                if (string.IsNullOrEmpty(editCardId)) return;

                string cardType = CardTypePicker.SelectedItem as string;
                string frontText = FrontTextEditor.Text?.Replace("\r\n", "\n").Replace("\r", "\n") ?? "";
                string backText = BackTextEditor.Text?.Replace("\r\n", "\n").Replace("\r", "\n") ?? "";
                string choiceQuestion = ChoiceQuestion.Text?.Replace("\r\n", "\n").Replace("\r", "\n") ?? "";
                string choiceExplanation = ChoiceQuestionExplanation.Text?.Replace("\r\n", "\n").Replace("\r", "\n") ?? "";

                var choices = new List<object>();
                foreach (var stack in ChoicesContainer.Children.OfType<StackLayout>())
                {
                    var entry = stack.Children.OfType<Editor>().FirstOrDefault();
                    var checkBox = stack.Children.OfType<CheckBox>().FirstOrDefault();

                    if (entry != null && !string.IsNullOrWhiteSpace(entry.Text))
                    {
                        string cleanText = Regex.Replace(entry.Text, @"^\d+\.\s*", "").Trim()
                            .Replace("\r\n", "\n")
                            .Replace("\r", "\n");
                        bool isCorrect = checkBox?.IsChecked == true;
                        choices.Add(new
                        {
                            isCorrect = isCorrect,
                            text = cleanText
                        });
                    }
                }

                // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’JSONã¨ã—ã¦ä¿å­E                var cardData = new
                {
                    id = editCardId,
                    type = cardType,
                    front = frontText,
                    back = backText,
                    question = choiceQuestion,
                    explanation = choiceExplanation,
                    choices = choices,
                    selectionRects = selectionRects.Select(r => new
                    {
                        x = r.Left,
                        y = r.Top,
                        width = r.Width,
                        height = r.Height
                    }).ToList()
                };

                string jsonPath = Path.Combine(tempExtractPath, "cards", $"{editCardId}.json");
                string jsonContent = JsonSerializer.Serialize(cardData, new JsonSerializerOptions
                {
                    WriteIndented = true,
                    Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping,
                    DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
                });
                await File.WriteAllTextAsync(jsonPath, jsonContent);

                // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆãEã¿cards.txtã®æ›´æ–°æ—¥æ™‚ã‚’æ›´æ–°
                if (isDirty)
                {
                    string cardsFilePath = Path.Combine(tempExtractPath, "cards.txt");
                    if (File.Exists(cardsFilePath))
                    {
                        var lines = await File.ReadAllLinesAsync(cardsFilePath);
                        var newLines = new List<string>();
                        bool cardUpdated = false;

                        // 1è¡Œç›®ã¯ç”»åƒç•ªå·ãªã®ã§ããEã¾ã¾ä¿æŒ
                        if (lines.Length > 0)
                        {
                            newLines.Add(lines[0]);
                        }

                        // ã‚«ãƒ¼ãƒ‰æƒ…å ±ã®æ›´æ–°
                        for (int i = 1; i < lines.Length; i++)
                        {
                            var parts = lines[i].Split(',');
                            if (parts.Length >= 2 && parts[0] == editCardId)
                            {
                                // æ›´æ–°æ—¥æ™‚ã‚’ç¾åœ¨æ™‚åˆ»ã«æ›´æ–°
                                newLines.Add($"{editCardId},{DateTime.Now:yyyy-MM-dd HH:mm:ss}");
                                cardUpdated = true;
                            }
                            else
                            {
                                newLines.Add(lines[i]);
                            }
                        }

                        // ã‚«ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªãE ´åˆãEæ–°è¦è¿½åŠ 
                        if (!cardUpdated)
                        {
                            newLines.Add($"{editCardId},{DateTime.Now:yyyy-MM-dd HH:mm:ss}");
                        }

                        await File.WriteAllLinesAsync(cardsFilePath, newLines);
                    }
                }

                // .ankpls ã‚’æ›´æ–°
                if (File.Exists(ankplsFilePath))
                {
                    File.Delete(ankplsFilePath);
                }
                ZipFile.CreateFromDirectory(tempExtractPath, ankplsFilePath);

                isDirty = false;
                Debug.WriteLine("ã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ");
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"è‡ªå‹•ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                Debug.WriteLine($"ã‚¹ã‚¿ãƒE‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: {ex.StackTrace}");
            }
        }

        private async void OnCardSelected(object sender, SelectionChangedEventArgs e)
        {
            if (e.CurrentSelection.FirstOrDefault() is CardInfo selectedCard)
            {
                // ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­E                if (isDirty && !string.IsNullOrEmpty(editCardId))
                {
                    await SaveCurrentCard();
                }

                // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
                editCardId = selectedCard.Id;
                LoadCardData(selectedCard.Id);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¼·åˆ¶æ›´æ–°
                await Task.Delay(200); // WebViewåˆæœŸåŒ–ã‚’å¾E¤
                
                var cardType = CardTypePicker.SelectedItem?.ToString();
                Debug.WriteLine($"ã‚«ãƒ¼ãƒ‰é¸æŠå¾ŒãEãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°: {cardType}");
                
                switch (cardType)
                {
                    case "åŸºæœ¬ãƒ»ç©´åŸ‹ã‚":
                        Debug.WriteLine("åŸºæœ¬ã‚«ãƒ¼ãƒ‰ãEãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°");
                                        FrontPreviewLabel.RichText = FrontTextEditor.Text ?? "";
                FrontPreviewLabel.ShowAnswer = false;
                FrontPreviewLabel.ImageFolderPath = tempExtractPath;
                
                BackPreviewLabel.RichText = BackTextEditor.Text ?? "";
                BackPreviewLabel.ShowAnswer = false;
                BackPreviewLabel.ImageFolderPath = tempExtractPath;
                        break;
                    case "é¸æŠè‚¢":
                        Debug.WriteLine("é¸æŠè‚¢ã‚«ãƒ¼ãƒ‰ãEãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°");
                        ChoicePreviewLabel.RichText = ChoiceQuestion.Text ?? "";
                        ChoicePreviewLabel.ShowAnswer = false;
                        ChoicePreviewLabel.ImageFolderPath = tempExtractPath;
                        
                        ChoiceExplanationPreviewLabel.RichText = ChoiceQuestionExplanation.Text ?? "";
                        ChoiceExplanationPreviewLabel.ShowAnswer = false;
                        ChoiceExplanationPreviewLabel.ImageFolderPath = tempExtractPath;
                        break;
                }
            }
        }

        protected override async void OnDisappearing()
        {
            base.OnDisappearing();
            // ç”»é¢ã‚’é›¢ã‚Œã‚‹æ™‚ã«ä¿å­E            if (isDirty && !string.IsNullOrEmpty(editCardId))
            {
                await SaveCurrentCard();
            }
            
            // ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾
            autoSaveTimer?.Stop();
            autoSaveTimer?.Dispose();
            
            _frontPreviewTimer?.Stop();
            _frontPreviewTimer?.Dispose();
            
            _backPreviewTimer?.Stop();
            _backPreviewTimer?.Dispose();
            
            _choiceQuestionPreviewTimer?.Stop();
            _choiceQuestionPreviewTimer?.Dispose();
            
            _choiceExplanationPreviewTimer?.Stop();
            _choiceExplanationPreviewTimer?.Dispose();
        }

        private void OnEditCardClicked(object sender, EventArgs e)
        {
            if (sender is Button button && button.CommandParameter is CardInfo card)
            {
                // ã‚«ãƒ¼ãƒ‰ç·¨é›E”»é¢ã«é·ç§»
                Navigation.PushAsync(new Add(ankplsFilePath, tempExtractPath, card.Id));
            }
        }

        private void LoadCardData(string cardId)
        {
            try
            {
                Debug.WriteLine($"LoadCardDataé–‹å§E- cardId: {cardId}");
                var jsonPath = Path.Combine(tempExtractPath, "cards", $"{cardId}.json");
                
                if (File.Exists(jsonPath))
                {
                    var jsonContent = File.ReadAllText(jsonPath);
                    var cardData = JsonSerializer.Deserialize<CardData>(jsonContent);

                    // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã‚’è¨­å®E                    int typeIndex = CardTypePicker.Items.IndexOf(cardData.type);
                    if (typeIndex >= 0)
                    {
                        CardTypePicker.SelectedIndex = typeIndex;
                    }
                    
                    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãEè¡¨ç¤ºåˆ¶å¾¡ã‚’ç›´æ¥å®Ÿè¡E                    BasicCardLayout.IsVisible = cardData.type == "åŸºæœ¬ãƒ»ç©´åŸ‹ã‚";
                    MultipleChoiceLayout.IsVisible = cardData.type == "é¸æŠè‚¢";
                    ImageFillLayout.IsVisible = cardData.type == "ç”»åƒç©´åŸ‹ã‚";
                    
                    Debug.WriteLine($"ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¶å¾¡: {cardData.type} - Basic:{BasicCardLayout.IsVisible}, Choice:{MultipleChoiceLayout.IsVisible}, Image:{ImageFillLayout.IsVisible}");

                    // ã‚«ãƒ¼ãƒ‰ãEå†E®¹ã‚’è¨­å®E                    if (cardData.type == "é¸æŠè‚¢")
                    {
                        ChoiceQuestion.Text = cardData.question ?? "";
                        ChoiceQuestionExplanation.Text = cardData.explanation ?? "";
                        
                        // TextChangedã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®E                        ChoiceQuestion.TextChanged -= OnChoiceQuestionTextChanged; // é‡è¤E‚’é˜²ããŸã‚ä¸€åº¦å‰Šé™¤
                        ChoiceQuestion.TextChanged += OnChoiceQuestionTextChanged;
                        ChoiceQuestionExplanation.TextChanged -= OnChoiceExplanationTextChanged;
                        ChoiceQuestionExplanation.TextChanged += OnChoiceExplanationTextChanged;
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’JavaScriptæ‰‹æ³•ã§åˆæœŸåŒ–ï¼ˆåEæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒEƒˆEE                        _choicePreviewInitialized = false;
                        _choiceExplanationPreviewInitialized = false;
                        
                        Debug.WriteLine($"é¸æŠè‚¢ã‚«ãƒ¼ãƒ‰ãEãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆæœŸåŒE question='{cardData.question}', explanation='{cardData.explanation}'");
                        
                        // é¸æŠè‚¢ã‚’è¨­å®E                        if (cardData.choices != null)
                        {
                            ChoicesContainer.Children.Clear();
                            foreach (var choice in cardData.choices)
                            {
                                var stack = new StackLayout { Orientation = StackOrientation.Horizontal };
                                var checkBox = new CheckBox { IsChecked = choice.isCorrect };
                                var editor = new Editor
                                {
                                    Text = choice.text ?? "",
                                    HeightRequest = 40,
                                    AutoSize = EditorAutoSizeOption.TextChanges
                                };
                                
                                // TextChangedã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                                editor.TextChanged += OnChoiceTextChanged;

                                // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿E                                editor.SetAppThemeColor(Editor.BackgroundColorProperty, Colors.White, Color.FromArgb("#2D2D30"));
                                editor.SetAppThemeColor(Editor.TextColorProperty, Colors.Black, Colors.White);

                                stack.Children.Add(checkBox);
                                stack.Children.Add(editor);
                                ChoicesContainer.Children.Add(stack);
                            }
                        }
                    }
                    else
                    {
                        FrontTextEditor.Text = cardData.front ?? "";
                        BackTextEditor.Text = cardData.back ?? "";
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’JavaScriptæ‰‹æ³•ã§åˆæœŸåŒ–ï¼ˆåEæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒEƒˆEE                        _frontPreviewInitialized = false;
                        _backPreviewInitialized = false;
                        
                        Debug.WriteLine($"åŸºæœ¬ã‚«ãƒ¼ãƒ‰ãEãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆæœŸåŒE front='{cardData.front}', back='{cardData.back}'");
                    }

                    // ç”»åƒç©´åŸ‹ã‚ã®å ´åˆã€E¸æŠç¯E›²ã‚’è¨­å®E                    if (cardData.type == "ç”»åƒç©´åŸ‹ã‚" && cardData.selectionRects != null)
                    {
                        selectionRects.Clear();
                        foreach (var rect in cardData.selectionRects)
                        {
                            selectionRects.Add(new SKRect(rect.x, rect.y, rect.x + rect.width, rect.y + rect.height));
                        }
                    }
                }
                Debug.WriteLine("LoadCardDataå®ŒäºE);
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"LoadCardDataã§ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                Debug.WriteLine($"ã‚¹ã‚¿ãƒE‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: {ex.StackTrace}");
                throw;
            }
        }

        private class CardData
        {
            public string type { get; set; }
            public string front { get; set; }
            public string back { get; set; }
            public string question { get; set; }
            public string explanation { get; set; }
            public List<ChoiceData> choices { get; set; }
            public List<SelectionRect> selectionRects { get; set; }
        }

        private class ChoiceData
        {
            public bool isCorrect { get; set; }
            public string text { get; set; }
        }

        private class SelectionRect
        {
            public float x { get; set; }
            public float y { get; set; }
            public float width { get; set; }
            public float height { get; set; }
        }

        private void OnCardTypeChanged(object sender, EventArgs e)
        {
            string selectedType = CardTypePicker.SelectedItem as string;

            BasicCardLayout.IsVisible = selectedType == "åŸºæœ¬ãƒ»ç©´åŸ‹ã‚";
            MultipleChoiceLayout.IsVisible = selectedType == "é¸æŠè‚¢";
            ImageFillLayout.IsVisible = selectedType == "ç”»åƒç©´åŸ‹ã‚";
        }

        private void OnCanvasViewPaintSurface(object sender, SKPaintSurfaceEventArgs e)
        {
            var canvas = e.Surface.Canvas;
            canvas.Clear(SKColors.White);

            if (imageBitmap != null)
            {
                var rect = new SKRect(0, 0, e.Info.Width, e.Info.Height);
                canvas.DrawBitmap(imageBitmap, rect);
            }

            using (var paint = new SKPaint
            {
                Color = SKColors.Red,
                Style = SKPaintStyle.Stroke,
                StrokeWidth = 3
            })
            {
                foreach (var rect in selectionRects)
                {
                    canvas.DrawRect(rect, paint);
                }

                if (isDragging)
                {
                    var currentRect = SKRect.Create(
                        Math.Min(startPoint.X, endPoint.X),
                        Math.Min(startPoint.Y, endPoint.Y),
                        Math.Abs(endPoint.X - startPoint.X),
                        Math.Abs(endPoint.Y - startPoint.Y)
                    );
                    canvas.DrawRect(currentRect, paint);
                }
            }
        }

        private void OnCanvasTouch(object sender, SKTouchEventArgs e)
        {
            var point = e.Location;

            switch (e.ActionType)
            {
                case SKTouchAction.Pressed:
                    if (e.MouseButton == SKMouseButton.Right)
                    {
                        var clickedRect = selectionRects.FirstOrDefault(r => r.Contains(point));
                        if (clickedRect != SKRect.Empty)
                        {
                            ShowContextMenu(point, clickedRect);
                        }
                    }
                    else
                    {
                        isDragging = true;
                        startPoint = point;
                        endPoint = point;
                    }
                    break;

                case SKTouchAction.Moved:
                    if (isDragging)
                    {
                        endPoint = point;
                    }
                    break;

                case SKTouchAction.Released:
                    if (isDragging)
                    {
                        var rect = SKRect.Create(
                            Math.Min(startPoint.X, endPoint.X),
                            Math.Min(startPoint.Y, endPoint.Y),
                            Math.Abs(endPoint.X - startPoint.X),
                            Math.Abs(endPoint.Y - startPoint.Y)
                        );

                        if (!rect.IsEmpty && rect.Width > 5 && rect.Height > 5)
                        {
                            selectionRects.Add(rect);
                            isDirty = true;
                        }
                    }
                    isDragging = false;
                    break;
            }

            CanvasView.InvalidateSurface();
        }

        private async void ShowContextMenu(SKPoint point, SKRect rect)
        {
            var action = await DisplayActionSheet("å‰Šé™¤ã—ã¾ã™ã‹EE, "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", "å‰Šé™¤");

            if (action == "å‰Šé™¤")
            {
                selectionRects.Remove(rect);
                isDirty = true;
                CanvasView.InvalidateSurface();
            }
        }

        private async Task AddImage(Editor editor)
        {
            var result = await FilePicker.PickAsync(new PickOptions
            {
                PickerTitle = "ç”»åƒã‚’é¸æŠE,
                FileTypes = FilePickerFileType.Images
            });

            if (result != null)
            {
                // iOSç‰ˆã«åˆã‚ã›ã¦8æ¡_6æ¡ãEæ•°å­—å½¢å¼ã§IDã‚’ç”ŸæˆE                Random random = new Random();
                string imageId8 = random.Next(10000000, 99999999).ToString(); // 8æ¡ãEæ•°å­E                string imageId6 = random.Next(100000, 999999).ToString(); // 6æ¡ãEæ•°å­E                string imageId = $"{imageId8}_{imageId6}";

                string imageFolder = Path.Combine(tempExtractPath, "img");
                Directory.CreateDirectory(imageFolder);

                string newFileName = $"img_{imageId}.jpg";
                string newFilePath = Path.Combine(imageFolder, newFileName);

                // ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§åœ§ç¸®ã—ã¦ä¿å­E                using (var sourceStream = await result.OpenReadAsync())
                {
                    using (var bitmap = SKBitmap.Decode(sourceStream))
                    {
                        using (var image = SKImage.FromBitmap(bitmap))
                        using (var data = image.Encode(SKEncodedImageFormat.Jpeg, 80)) // å“è³ªã‚E0%ã«è¨­å®E                        using (var fileStream = File.Create(newFilePath))
                        {
                            data.SaveTo(fileStream);
                        }
                    }
                }

                // ã‚¨ãƒE‚£ã‚¿ã« `<<img_{imageId}.jpg>>` ã‚’æŒ¿å…¥
                int cursorPosition = editor.CursorPosition;
                string text = editor.Text ?? "";
                string newText = text.Insert(cursorPosition, $"<<img_{imageId}.jpg>>");
                editor.Text = newText;
                editor.CursorPosition = cursorPosition + $"<<img_{imageId}.jpg>>".Length;

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                if (editor == FrontTextEditor)
                {
                    FrontOnTextChanged(editor, new TextChangedEventArgs("", editor.Text));
                }
                else if (editor == BackTextEditor)
                {
                    BackOnTextChanged(editor, new TextChangedEventArgs("", editor.Text));
                }
            }
        }

        private async void FrontOnAddImageClicked(object sender, EventArgs e)
        {
            await AddImage(FrontTextEditor);
            FrontOnTextChanged(FrontTextEditor, new TextChangedEventArgs("", FrontTextEditor.Text));
        }

        private async void BackOnAddImageClicked(object sender, EventArgs e)
        {
            await AddImage(BackTextEditor);
            BackOnTextChanged(BackTextEditor, new TextChangedEventArgs("", BackTextEditor.Text));
        }

        private async void ChoiceQuestionOnAddImageClicked(object sender, EventArgs e)
        {
            await AddImage(ChoiceQuestion);
            OnChoiceQuestionTextChanged(ChoiceQuestion, new TextChangedEventArgs("", ChoiceQuestion.Text));
        }

        private async void ChoiceExplanationOnAddImageClicked(object sender, EventArgs e)
        {
            await AddImage(ChoiceQuestionExplanation);
            OnChoiceExplanationTextChanged(ChoiceQuestionExplanation, new TextChangedEventArgs("", ChoiceQuestionExplanation.Text));
        }

        private void OnAddChoice(object sender, EventArgs e)
        {
            var stack = new StackLayout { Orientation = StackOrientation.Horizontal };
            var checkBox = new CheckBox();
            var editor = new Editor
            {
                Placeholder = "é¸æŠè‚¢ã‚’åEåŠ›ï¼ˆæ”¹è¡Œã§åŒºåˆE£ã¦è¤E•°å…¥åŠ›å¯èƒ½EE,
                HeightRequest = 40,
                AutoSize = EditorAutoSizeOption.TextChanges
            };
            
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿E            editor.SetAppThemeColor(Editor.BackgroundColorProperty, Colors.White, Color.FromArgb("#2D2D30"));
            editor.SetAppThemeColor(Editor.TextColorProperty, Colors.Black, Colors.White);
            
            editor.TextChanged += OnChoiceTextChanged;

            stack.Children.Add(checkBox);
            stack.Children.Add(editor);

            ChoicesContainer.Children.Add(stack);
            isDirty = true;
            autoSaveTimer.Stop();
            autoSaveTimer.Start();
        }

        private void OnChoiceTextChanged(object sender, TextChangedEventArgs e)
        {
            var editor = sender as Editor;
            if (editor == null) return;

            // æ”¹è¡ŒãŒå«ã¾ã‚Œã¦ãE‚‹å ´åE            if (e.NewTextValue.Contains("\n") || e.NewTextValue.Contains("\r"))
            {
                // æ”¹è¡Œã§åˆE‰²ã—ã€ç©ºã®è¡Œã‚’é™¤å¤E                var choices = e.NewTextValue
                    .Replace("\r\n", "\n")  // ã¾ãE\r\n ã‚E\n ã«çµ±ä¸€
                    .Replace("\r", "\n")    // æ®‹ã‚Šã® \r ã‚E\n ã«å¤‰æ›
                    .Split(new[] { "\n" }, StringSplitOptions.RemoveEmptyEntries)  // \n ã§åˆE‰²
                    .Select(c => c.Trim())  // åE¡ŒãEå‰å¾ŒãEç©ºç™½ã‚’å‰Šé™¤
                    .Where(c => !string.IsNullOrWhiteSpace(c))  // ç©ºã®è¡Œã‚’é™¤å¤E                    .ToList();

                if (choices.Count > 0)
                {
                    // é¸æŠè‚¢ã‚³ãƒ³ãƒEƒŠã‚’ã‚¯ãƒªã‚¢
                    ChoicesContainer.Children.Clear();

                    // åE¸æŠè‚¢ã«å¯¾ã—ã¦æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæE
                    foreach (var choice in choices)
                    {
                        var stack = new StackLayout { Orientation = StackOrientation.Horizontal };
                        var checkBox = new CheckBox();
                        var newEditor = new Editor
                        {
                            Text = choice,
                            HeightRequest = 40,
                            AutoSize = EditorAutoSizeOption.TextChanges
                        };
                        
                        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿E                        newEditor.SetAppThemeColor(Editor.BackgroundColorProperty, Colors.White, Color.FromArgb("#2D2D30"));
                        newEditor.SetAppThemeColor(Editor.TextColorProperty, Colors.Black, Colors.White);
                        
                        newEditor.TextChanged += OnChoiceTextChanged;

                        stack.Children.Add(checkBox);
                        stack.Children.Add(newEditor);

                        ChoicesContainer.Children.Add(stack);
                    }
                }
            }

            isDirty = true;
            autoSaveTimer.Stop();
            autoSaveTimer.Start();
        }

        private async void OnSelectImage(object sender, EventArgs e)
        {
            var result = await FilePicker.PickAsync(new PickOptions
            {
                PickerTitle = "ç”»åƒã‚’é¸æŠE,
                FileTypes = FilePickerFileType.Images
            });

            if (result != null)
            {
                try
                {
                    // ç”»åƒã‚’èª­ã¿è¾¼ã‚€
                    using (var stream = File.OpenRead(result.FullPath))
                    {
                        imageBitmap = SKBitmap.Decode(stream);
                    }

                    // ç”»åƒãEã‚µã‚¤ã‚ºã‚’èª¿æ•´
                    if (imageBitmap != null)
                    {
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ç”»åƒã‚’ãƒªã‚µã‚¤ã‚º
                        var info = CanvasView.CanvasSize;
                        var scale = Math.Min(info.Width / imageBitmap.Width, info.Height / imageBitmap.Height);
                        var scaledWidth = imageBitmap.Width * scale;
                        var scaledHeight = imageBitmap.Height * scale;

                        var resizedBitmap = imageBitmap.Resize(
                            new SKImageInfo((int)scaledWidth, (int)scaledHeight),
                            SKFilterQuality.High
                        );

                        imageBitmap.Dispose();
                        imageBitmap = resizedBitmap;

                        // é¸æŠç¯E›²ã‚’ã‚¯ãƒªã‚¢
                        selectionRects.Clear();
                        isDirty = true;
                        CanvasView.InvalidateSurface();
                    }
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"ç”»åƒãEèª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                    await DisplayAlert("ã‚¨ãƒ©ãƒ¼", "ç”»åƒãEèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€E, "OK");
                }
            }
        }

        private void OnChoiceQuestionTextChanged(object sender, TextChangedEventArgs e)
        {
            isDirty = true;
            autoSaveTimer.Stop();
            autoSaveTimer.Start();

            // JavaScriptæ‰‹æ³•ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE            UpdateChoiceQuestionPreviewWithDebounce(e.NewTextValue ?? "");
        }

        private void OnChoiceExplanationTextChanged(object sender, TextChangedEventArgs e)
        {
            isDirty = true;
            autoSaveTimer.Stop();
            autoSaveTimer.Start();

            // JavaScriptæ‰‹æ³•ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE            UpdateChoiceExplanationPreviewWithDebounce(e.NewTextValue ?? "");
        }

        /// <summary>
        /// é¸æŠè‚¢å•é¡ŒãEãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE        /// </summary>
        private System.Timers.Timer _choiceQuestionPreviewTimer;
        private void UpdateChoiceQuestionPreviewWithDebounce(string text)
        {
            // æ—¢å­˜ãEã‚¿ã‚¤ãƒãEã‚’åœæ­¢
            _choiceQuestionPreviewTimer?.Stop();
            _choiceQuestionPreviewTimer?.Dispose();
            
            // æ–°ã—ã„ã‚¿ã‚¤ãƒãEã‚’ä½œæEEE00mså¾Œã«å®Ÿè¡Œï¼E            _choiceQuestionPreviewTimer = new System.Timers.Timer(300);
            _choiceQuestionPreviewTimer.Elapsed += (s, e) =>
            {
                MainThread.BeginInvokeOnMainThread(() =>
                {
                    try
                    {
                        ChoicePreviewLabel.RichText = text;
                        ChoicePreviewLabel.ShowAnswer = false;
                        ChoicePreviewLabel.ImageFolderPath = tempExtractPath;
                    }
                    catch (Exception ex)
                    {
                        Debug.WriteLine($"é¸æŠè‚¢å•é¡ŒãEãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                    }
                });
                _choiceQuestionPreviewTimer?.Stop();
                _choiceQuestionPreviewTimer?.Dispose();
                _choiceQuestionPreviewTimer = null;
            };
            _choiceQuestionPreviewTimer.AutoReset = false;
            _choiceQuestionPreviewTimer.Start();
        }

        /// <summary>
        /// é¸æŠè‚¢è§£èª¬ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°Eˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãEE        /// </summary>
        private System.Timers.Timer _choiceExplanationPreviewTimer;
        private void UpdateChoiceExplanationPreviewWithDebounce(string text)
        {
            // æ—¢å­˜ãEã‚¿ã‚¤ãƒãEã‚’åœæ­¢
            _choiceExplanationPreviewTimer?.Stop();
            _choiceExplanationPreviewTimer?.Dispose();
            
            // æ–°ã—ã„ã‚¿ã‚¤ãƒãEã‚’ä½œæEEE00mså¾Œã«å®Ÿè¡Œï¼E            _choiceExplanationPreviewTimer = new System.Timers.Timer(300);
            _choiceExplanationPreviewTimer.Elapsed += (s, e) =>
            {
                MainThread.BeginInvokeOnMainThread(() =>
                {
                    try
                    {
                        ChoiceExplanationPreviewLabel.RichText = text;
                        ChoiceExplanationPreviewLabel.ShowAnswer = false;
                        ChoiceExplanationPreviewLabel.ImageFolderPath = tempExtractPath;
                    }
                    catch (Exception ex)
                    {
                        Debug.WriteLine($"é¸æŠè‚¢è§£èª¬ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                    }
                });
                _choiceExplanationPreviewTimer?.Stop();
                _choiceExplanationPreviewTimer?.Dispose();
                _choiceExplanationPreviewTimer = null;
            };
            _choiceExplanationPreviewTimer.AutoReset = false;
            _choiceExplanationPreviewTimer.Start();
        }

        /// <summary>
        /// é¸æŠè‚¢å•é¡ŒãEãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°EEavaScriptæ‰‹æ³•ï¼E        /// </summary>
        private async Task UpdateChoiceQuestionPreviewAsync(string text)
        {
            try
            {
                if (!_choicePreviewInitialized)
                {
                    var baseHtml = CreateBaseHtmlTemplate();
                    ChoicePreviewWebView.Source = new HtmlWebViewSource { Html = baseHtml };
                    _choicePreviewInitialized = true;
                    
                    // WebViewã®èª­ã¿è¾¼ã¿å®ŒäºE‚’å¾E¤
                    var tcs = new TaskCompletionSource<bool>();
                    
                    void OnNavigated(object sender, WebNavigatedEventArgs e)
                    {
                        ChoicePreviewWebView.Navigated -= OnNavigated;
                        tcs.SetResult(true);
                    }
                    
                    ChoicePreviewWebView.Navigated += OnNavigated;
                    
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®E                    Device.StartTimer(TimeSpan.FromSeconds(3), () =>
                    {
                        if (!tcs.Task.IsCompleted)
                        {
                            ChoicePreviewWebView.Navigated -= OnNavigated;
                            tcs.SetResult(false);
                        }
                        return false;
                    });
                    
                    await tcs.Task;
                    
                    // WebViewã®å®ŒåEåˆæœŸåŒ–ã‚’å¾E¤
                    await Task.Delay(200);
                    await UpdateWebViewContent(ChoicePreviewWebView, text ?? "", false);
                }
                else
                {
                    // 2å›ç›®ä»¥é™ãEã‚³ãƒ³ãƒEƒ³ãƒEƒ¨åˆEEã¿æ›´æ–°
                    await UpdateWebViewContent(ChoicePreviewWebView, text ?? "", false);
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"é¸æŠè‚¢å•é¡ŒãEãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯Ešå¾“æ¥ã®æ–¹æ³•ã§æ›´æ–°
                try
                {
                    var fallbackHtml = ConvertMarkdownToHtml(text ?? "");
                    ChoicePreviewWebView.Source = new HtmlWebViewSource { Html = fallbackHtml };
                }
                catch (Exception fallbackEx)
                {
                    Debug.WriteLine($"ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼: {fallbackEx.Message}");
                }
            }
        }

        /// <summary>
        /// é¸æŠè‚¢è§£èª¬ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°EEavaScriptæ‰‹æ³•ï¼E        /// </summary>
        private async Task UpdateChoiceExplanationPreviewAsync(string text)
        {
            try
            {
                if (!_choiceExplanationPreviewInitialized)
                {
                    var baseHtml = CreateBaseHtmlTemplate();
                    ChoiceExplanationPreviewWebView.Source = new HtmlWebViewSource { Html = baseHtml };
                    _choiceExplanationPreviewInitialized = true;
                    
                    // WebViewã®èª­ã¿è¾¼ã¿å®ŒäºE‚’å¾E¤
                    var tcs = new TaskCompletionSource<bool>();
                    
                    void OnNavigated(object sender, WebNavigatedEventArgs e)
                    {
                        ChoiceExplanationPreviewWebView.Navigated -= OnNavigated;
                        tcs.SetResult(true);
                    }
                    
                    ChoiceExplanationPreviewWebView.Navigated += OnNavigated;
                    
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®E                    Device.StartTimer(TimeSpan.FromSeconds(3), () =>
                    {
                        if (!tcs.Task.IsCompleted)
                        {
                            ChoiceExplanationPreviewWebView.Navigated -= OnNavigated;
                            tcs.SetResult(false);
                        }
                        return false;
                    });
                    
                    await tcs.Task;
                    
                    // WebViewã®å®ŒåEåˆæœŸåŒ–ã‚’å¾E¤
                    await Task.Delay(200);
                    await UpdateWebViewContent(ChoiceExplanationPreviewWebView, text ?? "", false);
                }
                else
                {
                    // 2å›ç›®ä»¥é™ãEã‚³ãƒ³ãƒEƒ³ãƒEƒ¨åˆEEã¿æ›´æ–°
                    await UpdateWebViewContent(ChoiceExplanationPreviewWebView, text ?? "", false);
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"é¸æŠè‚¢è§£èª¬ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: {ex.Message}");
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯Ešå¾“æ¥ã®æ–¹æ³•ã§æ›´æ–°
                try
                {
                    var fallbackHtml = ConvertMarkdownToHtml(text ?? "");
                    ChoiceExplanationPreviewWebView.Source = new HtmlWebViewSource { Html = fallbackHtml };
                }
                catch (Exception fallbackEx)
                {
                    Debug.WriteLine($"ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼: {fallbackEx.Message}");
                }
            }
        }

        private void OnSearchTextChanged(object sender, TextChangedEventArgs e)
        {
            PerformSearch(e.NewTextValue);
        }

        private void OnClearSearchClicked(object sender, EventArgs e)
        {
            CardSearchBar.Text = "";
            PerformSearch("");
        }

        private void PerformSearch(string searchText)
        {
            if (string.IsNullOrWhiteSpace(searchText))
            {
                // æ¤œç´¢ãƒE‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã€åEã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                filteredCards = new List<CardInfo>(cards);
            }
            else
            {
                // å¤§æ–E­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªãE¤œç´¢
                string lowerSearchText = searchText.ToLower();
                filteredCards = cards.Where(card =>
                    card.FrontText.ToLower().Contains(lowerSearchText) ||
                    (card.ImageInfo != null && card.ImageInfo.ToLower().Contains(lowerSearchText))
                ).ToList();
            }

            CardsCollectionView.ItemsSource = filteredCards;
            UpdateSearchResult();
        }

        private void UpdateSearchResult()
        {
            if (string.IsNullOrWhiteSpace(CardSearchBar.Text))
            {
                SearchResultLabel.Text = $"å…¨{cards.Count}ä»¶";
            }
            else
            {
                SearchResultLabel.Text = $"{filteredCards.Count}/{cards.Count}ä»¶";
            }
        }
    }
} 
